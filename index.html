<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç§˜å¯†ã®éƒ¨å±‹</title>

<!-- PWA -->
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="./icon-192.png">

<style>
  body { text-align:center; font-family:sans-serif; }
  .row { margin: 10px 0; }
  button { font-size: 18px; padding: 12px 18px; margin: 6px; }
  input { font-size: 18px; padding: 10px; width: 180px; }
  .panel {
    display:inline-block; padding: 14px 18px; border: 1px solid #ccc;
    border-radius: 10px; margin: 8px; vertical-align: top; min-width: 320px;
  }
  .small { font-size: 13px; color:#444; }
  .msg { margin-top: 8px; min-height: 22px; font-size: 14px; white-space: pre-line; }
  hr { margin: 12px 0; }
  .big { font-size: 22px; }
  canvas { border:1px solid #ddd; border-radius: 8px; display:block; margin: 10px auto; }
  .reels { display:flex; justify-content:center; gap:10px; margin: 10px 0; }
  .reel {
    width:72px; height:72px; border:1px solid #ccc; border-radius: 12px;
    display:flex; align-items:center; justify-content:center; font-size: 34px;
    user-select:none;
  }
  .reel.spin { animation: wobble 0.2s linear infinite; }
  @keyframes wobble { 0%{transform:translateY(0)} 50%{transform:translateY(-2px)} 100%{transform:translateY(0)} }
</style>
</head>
<body>

<h1>ç§˜å¯†ã®éƒ¨å±‹</h1>
<div class="big">
  è²¡å¸ƒï¼š<span id="wallet">0</span> å††ã€€ï¼ã€€é é‡‘ï¼š<span id="bank">0</span> å††
</div>
<div class="small">
  â€»ã€Œã‚¹ã‚¿ãƒ¼ãƒˆï¼ã‚¹ãƒˆãƒƒãƒ—ã€ã¯è²¡å¸ƒã®è‡ªå‹•å¢—åŠ ã®ã¿ã€‚é é‡‘åˆ©æ¯ã¯æ™‚é–“çµŒéã§ä»˜ä¸ï¼ˆä½åˆ©ãƒ»ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯ï¼‰ã€‚
  æ ªä¾¡ã¯ã‚¹ãƒˆãƒƒãƒ—ä¸­ã§ã‚‚å‹•ãç¶šã‘ã¾ã™ï¼ˆã‚¿ãƒ–éè¡¨ç¤ºæ™‚ã¯ãƒ–ãƒ©ã‚¦ã‚¶éƒ½åˆã§é–“å¼•ãã‚ã‚Šï¼‰ã€‚
</div>

<div class="row">
  <button id="start">ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆè²¡å¸ƒå¢—åŠ ONï¼‰</button>
  <button id="stop">ã‚¹ãƒˆãƒƒãƒ—ï¼ˆè²¡å¸ƒå¢—åŠ OFFï¼‰</button>
</div>

<!-- é€Ÿåº¦ã‚¢ãƒƒãƒ—ï¼ˆè²¡å¸ƒå¢—åŠ ï¼‰ -->
<div class="panel">
  <div><b>è‡ªå‹•å¢—åŠ ï¼ˆè²¡å¸ƒï¼‰</b></div>
  <div>å¢—åŠ é–“éš”ï¼š<b><span id="intervalMs">500</span> ms</b></div>
  <div class="small">ï¼ˆçŸ­ã„ã»ã©é€Ÿã„ï¼‰</div>
  <hr>
  <div>ã‚¢ã‚¤ãƒ†ãƒ ï¼š<b>é«˜é€ŸåŒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«</b></div>
  <div>ä¾¡æ ¼ï¼š<b><span id="cost">50</span></b> å††</div>
  <div>è³¼å…¥å›æ•°ï¼š<b><span id="level">0</span></b></div>
  <button id="buy">è³¼å…¥ã—ã¦é€Ÿãã™ã‚‹</button>
  <div class="small">â€»æœ€é€Ÿï¼š100msï¼ˆä¸Šé™ï¼‰</div>
  <div class="msg" id="msgWallet"></div>
</div>

<!-- é é‡‘ï¼ˆä½åˆ©ãƒ»ç„¡é™å¢—æ®–ï¼‰ -->
<div class="panel">
  <div><b>é é‡‘ï¼ˆå…¥é‡‘ï¼å¼•ãå‡ºã—ï¼‰</b></div>
  <div class="row">
    <input id="amount" type="number" min="1" step="1" placeholder="é‡‘é¡ï¼ˆæ•´æ•°ï¼‰">
  </div>
  <div class="row">
    <button id="deposit">é é‡‘ã¸å…¥ã‚Œã‚‹</button>
    <button id="withdraw">é é‡‘ã‹ã‚‰å¼•ãå‡ºã™</button>
  </div>

  <hr>

  <div><b>é é‡‘åˆ©æ¯ï¼ˆä½åˆ©ãƒ»ç„¡é™ï¼‰</b></div>
  <div>åˆ©ç‡ï¼š<b><span id="rateText"></span></b></div>
  <div>ä»˜ä¸é–“éš”ï¼š<b><span id="interestIntervalText"></span></b></div>
  <div class="small">â€»ã‚¹ã‚¿ãƒ¼ãƒˆ/ã‚¹ãƒˆãƒƒãƒ—ã«é–¢ä¿‚ãªãæ™‚é–“çµŒéã§åˆ©æ¯ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŠ ç®—ï¼‰</div>

  <div class="msg" id="msgBank"></div>
</div>

<!-- æ ªï¼ˆå¸¸æ™‚ç¨¼åƒï¼‰ -->
<div class="panel">
  <div><b>æ ªï¼šé•·å°¾ãƒ†ãƒƒã‚¯ï¼ˆå¸¸æ™‚ç¨¼åƒï¼‰</b></div>
  <div>æ ªä¾¡ï¼š<b>Â¥<span id="stockPrice">100.0</span></b></div>
  <div class="small">
    çŠ¶æ…‹ï¼š<b><span id="trendState">---</span></b>ï¼ˆãƒˆãƒ¬ãƒ³ãƒ‰ï¼‰ï¼
    ã‚¤ãƒ™ãƒ³ãƒˆï¼š<b><span id="eventState">---</span></b>
  </div>

  <canvas id="chart" width="320" height="140"></canvas>
  <div class="small">éå»60ç§’ï¼ˆ1ç§’ã”ã¨ã®ä¾¡æ ¼ï¼‰</div>

  <hr>

  <div>ä¿æœ‰æ ªï¼š<b><span id="shares">0</span></b> æ ª</div>
  <div class="small">è©•ä¾¡é¡ï¼šÂ¥<span id="positionValue">0</span></div>

  <div class="row">
    <input id="shareAmount" type="number" min="1" step="1" placeholder="æ ªæ•°ï¼ˆæ•´æ•°ï¼‰">
  </div>
  <div class="row">
    <button id="buyShares">è²·ã†</button>
    <button id="sellShares">å£²ã‚‹</button>
  </div>

  <hr>

  <div><b>æ ªã®è¨­å®š</b></div>
  <div class="small">
    æ›´æ–°ï¼š<span id="stockTickText"></span> ï¼ ãƒœãƒ©ï¼š<span id="stockVolText"></span><br>
    æš´è½ç¢ºç‡ï¼š<span id="crashProbText"></span> ï¼ ãƒãƒ–ãƒ«ç¢ºç‡ï¼š<span id="bubbleProbText"></span> ï¼ è¶…ãƒãƒ–ãƒ«ç¢ºç‡ï¼š<span id="superBubbleProbText"></span><br>
    æš´è½å€ç‡ï¼š<span id="crashMultText"></span> ï¼ ãƒãƒ–ãƒ«å€ç‡ï¼š<span id="bubbleMultText"></span> ï¼ è¶…ãƒãƒ–ãƒ«å€ç‡ï¼š<span id="superBubbleMultText"></span><br>
    å¹³å‡å›å¸°ï¼šåŸºæº– <span id="meanPriceText"></span> ï¼ å¼·ã• <span id="meanRevertText"></span>
  </div>

  <div class="msg" id="msgStock"></div>
</div>

<!-- ã‚¹ãƒ­ãƒƒãƒˆ -->
<div class="panel">
  <div><b>ã‚¹ãƒ­ãƒƒãƒˆï¼ˆRTP 99% / ã‚ªãƒ¼ãƒˆå¯¾å¿œï¼‰</b></div>
  <div class="small">
    â€»RTP=é•·æœŸã®æœŸå¾…æ‰•ã„æˆ»ã—ç‡ï¼ˆçŸ­æœŸã¯ä¸Šä¸‹ï¼‰<br>
    ãƒ™ãƒƒãƒˆä¸Šé™ãªã—ã€‚è²¡å¸ƒã‹ã‚‰å¼•ã‹ã‚Œã€å½“é¸æ™‚ã¯è²¡å¸ƒã«åŠ ç®—ã€‚
  </div>

  <div class="reels">
    <div class="reel" id="reel1">ğŸ’</div>
    <div class="reel" id="reel2">ğŸ‹</div>
    <div class="reel" id="reel3">ğŸ””</div>
  </div>

  <div class="row">
    <input id="bet" type="number" min="1" step="1" placeholder="ãƒ™ãƒƒãƒˆé¡ï¼ˆå††ï¼‰">
  </div>
  <div class="row">
    <button id="spin">å›ã™</button>
    <button id="autoStart">ã‚ªãƒ¼ãƒˆé–‹å§‹</button>
    <button id="autoStop">ã‚ªãƒ¼ãƒˆåœæ­¢</button>
  </div>

  <hr>

  <div class="small">
    ç¾åœ¨ã®RTPè¨­å®šï¼š<b><span id="rtpText">---</span></b><br>
    é…å½“ã‚¹ã‚±ãƒ¼ãƒ«ï¼š<b><span id="scaleText">---</span></b>
  </div>

  <div class="msg" id="msgSlot"></div>
</div>

<script>
/** =======================
 * ä¿å­˜ã‚­ãƒ¼
 * ======================= */
const KEY_WALLET   = "wallet";
const KEY_BANK     = "bank";
const KEY_INTERVAL = "intervalMs";
const KEY_LEVEL    = "speedLevel";
const KEY_COST     = "speedCost";

// é é‡‘åˆ©æ¯ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³è¨ˆç®—ç”¨ï¼‰
const KEY_BANK_REM = "bankRemainder";
const KEY_BANK_LAST_TS = "bankLastInterestTs";

// æ ª
const KEY_STOCK_PRICE = "stockPrice";
const KEY_SHARES      = "stockShares";
const KEY_TREND_STATE = "trendState";
const KEY_TREND_UNTIL = "trendUntilTs";
const KEY_PRICE_SERIES = "priceSeries"; // éå»60ç‚¹

/** =======================
 * åˆæœŸå€¤
 * ======================= */
let wallet      = Number(localStorage.getItem(KEY_WALLET)) || 0;
let bank        = Number(localStorage.getItem(KEY_BANK)) || 0;
let intervalMs  = Number(localStorage.getItem(KEY_INTERVAL)) || 500;
let level       = Number(localStorage.getItem(KEY_LEVEL)) || 0;
let cost        = Number(localStorage.getItem(KEY_COST)) || 50;

let bankRemainder = Number(localStorage.getItem(KEY_BANK_REM)) || 0;
let bankLastInterestTs = Number(localStorage.getItem(KEY_BANK_LAST_TS)) || Date.now();

// æ ª
let stockPrice  = Number(localStorage.getItem(KEY_STOCK_PRICE)) || 100;
let shares      = Number(localStorage.getItem(KEY_SHARES)) || 0;
let trendState  = localStorage.getItem(KEY_TREND_STATE) || "BULL";
let trendUntilTs= Number(localStorage.getItem(KEY_TREND_UNTIL)) || (Date.now() + 30000);

// ãƒãƒ£ãƒ¼ãƒˆç³»åˆ—
let priceSeries = [];
try {
  const raw = localStorage.getItem(KEY_PRICE_SERIES);
  if (raw) priceSeries = JSON.parse(raw);
} catch (_) {}
if (!Array.isArray(priceSeries)) priceSeries = [];
if (priceSeries.length === 0) priceSeries = Array.from({length: 60}, () => Number(stockPrice.toFixed(1)));

/** =======================
 * è¨­å®š
 * ======================= */
const MIN_INTERVAL = 100;

// é é‡‘åˆ©æ¯ï¼ˆä½åˆ©ï¼‰
const INTEREST_INTERVAL_MS = 10000; // 10ç§’
const INTEREST_RATE = 0.0005;       // 0.05% / 10ç§’

// æ ªï¼ˆå¸¸æ™‚ï¼‰
const STOCK_TICK_MS = 1000;
const STOCK_VOLATILITY = 2.5;
const DRIFT_BULL = 0.35;
const DRIFT_BEAR = -0.35;
const TREND_MIN_MS = 20000;
const TREND_MAX_MS = 60000;

// ã‚¤ãƒ™ãƒ³ãƒˆ
const CRASH_PROB = 0.01;
const BUBBLE_PROB = 0.01;
const SUPER_BUBBLE_PROB = 0.002;

// æš´è½ï¼ˆãƒã‚¤ãƒ«ãƒ‰ï¼‰
const CRASH_MULT_MIN = 0.85;
const CRASH_MULT_MAX = 0.95;

// ãƒãƒ–ãƒ«å›ºå®šÃ—1.43
const BUBBLE_MULT_MIN = 1.43;
const BUBBLE_MULT_MAX = 1.43;

// è¶…ãƒãƒ–ãƒ«å›ºå®š
const SUPER_BUBBLE_MULT = 2.00;

// ä¸‹é™
const STOCK_FLOOR = 1.0;

// å¹³å‡å›å¸°
const MEAN_PRICE = 100;
const MEAN_REVERT = 0.02;

/** =======================
 * ã‚¹ãƒ­ãƒƒãƒˆï¼ˆRTP 99%ï¼‰
 * ======================= */
const TARGET_RTP = 0.99;

// ã‚·ãƒ³ãƒœãƒ«ã¨é‡ã¿ï¼ˆå‡ºã‚„ã™ã•ï¼‰
const SYMBOLS = [
  { s: "ğŸ’", w: 30 },
  { s: "ğŸ‹", w: 26 },
  { s: "ğŸ””", w: 18 },
  { s: "â­", w: 14 },
  { s: "7ï¸âƒ£", w: 9 },
  { s: "ğŸ’", w: 3 }
];

// åŸºæœ¬é…å½“ï¼ˆã“ã®å¾Œã€RTP99%ã«ãªã‚‹ã‚ˆã†è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒ«ã™ã‚‹ï¼‰
// 3ã¤æƒã„å€ç‡ï¼ˆãƒ™ãƒƒãƒˆÃ—å€ç‡ï¼‰
const BASE_PAYOUT_3 = {
  "ğŸ’": 3.0,
  "ğŸ‹": 3.2,
  "ğŸ””": 4.0,
  "â­": 6.0,
  "7ï¸âƒ£": 10.0,
  "ğŸ’": 30.0
};
// 2ã¤æƒã„å€ç‡ï¼ˆã©ã‚Œã‹2ä¸€è‡´ã§è–„ãè¿”ã™ï¼‰
const BASE_PAYOUT_2 = {
  "ğŸ’": 0.2,
  "ğŸ‹": 0.2,
  "ğŸ””": 0.25,
  "â­": 0.35,
  "7ï¸âƒ£": 0.6,
  "ğŸ’": 1.5
};

// ã‚ªãƒ¼ãƒˆã‚¹ãƒ”ãƒ³
let autoTimer = null;
const AUTO_SPIN_MS = 700; // å¥½ãã«èª¿æ•´å¯

/** =======================
 * ã‚¿ã‚¤ãƒãƒ¼
 * ======================= */
let walletTimer = null;  // è²¡å¸ƒ è‡ªå‹•å¢—åŠ ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆä¸­ã®ã¿ï¼‰
let stockTimer  = null;  // æ ªä¾¡æ›´æ–°ï¼ˆå¸¸æ™‚ï¼‰
let chartTimer  = null;

/** =======================
 * DOM
 * ======================= */
const elWallet = document.getElementById("wallet");
const elBank   = document.getElementById("bank");
const elInterval = document.getElementById("intervalMs");
const elCost   = document.getElementById("cost");
const elLevel  = document.getElementById("level");
const msgWallet= document.getElementById("msgWallet");

const btnStart = document.getElementById("start");
const btnStop  = document.getElementById("stop");
const btnBuy   = document.getElementById("buy");

const inpAmount = document.getElementById("amount");
const btnDeposit = document.getElementById("deposit");
const btnWithdraw = document.getElementById("withdraw");
const msgBank = document.getElementById("msgBank");
const elRateText = document.getElementById("rateText");
const elInterestIntervalText = document.getElementById("interestIntervalText");

// æ ª
const elStockPrice = document.getElementById("stockPrice");
const elShares = document.getElementById("shares");
const elPositionValue = document.getElementById("positionValue");
const inpShareAmount = document.getElementById("shareAmount");
const btnBuyShares = document.getElementById("buyShares");
const btnSellShares = document.getElementById("sellShares");
const msgStock = document.getElementById("msgStock");

const elTrendState = document.getElementById("trendState");
const elEventState = document.getElementById("eventState");

const elStockTickText = document.getElementById("stockTickText");
const elStockVolText = document.getElementById("stockVolText");
const elCrashProbText = document.getElementById("crashProbText");
const elBubbleProbText = document.getElementById("bubbleProbText");
const elSuperBubbleProbText = document.getElementById("superBubbleProbText");

const elCrashMultText = document.getElementById("crashMultText");
const elBubbleMultText = document.getElementById("bubbleMultText");
const elSuperBubbleMultText = document.getElementById("superBubbleMultText");
const elMeanPriceText = document.getElementById("meanPriceText");
const elMeanRevertText = document.getElementById("meanRevertText");

const canvas = document.getElementById("chart");
const ctx = canvas.getContext("2d");

// ã‚¹ãƒ­ãƒƒãƒˆ
const reel1 = document.getElementById("reel1");
const reel2 = document.getElementById("reel2");
const reel3 = document.getElementById("reel3");
const inpBet = document.getElementById("bet");
const btnSpin = document.getElementById("spin");
const btnAutoStart = document.getElementById("autoStart");
const btnAutoStop = document.getElementById("autoStop");
const msgSlot = document.getElementById("msgSlot");
const elRtpText = document.getElementById("rtpText");
const elScaleText = document.getElementById("scaleText");

/** =======================
 * ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 * ======================= */
function setMsg(el, text) { el.textContent = text; }
function randBetween(a, b) { return a + Math.random() * (b - a); }

function saveAll() {
  localStorage.setItem(KEY_WALLET, wallet);
  localStorage.setItem(KEY_BANK, bank);
  localStorage.setItem(KEY_INTERVAL, intervalMs);
  localStorage.setItem(KEY_LEVEL, level);
  localStorage.setItem(KEY_COST, cost);

  localStorage.setItem(KEY_BANK_REM, bankRemainder);
  localStorage.setItem(KEY_BANK_LAST_TS, bankLastInterestTs);

  localStorage.setItem(KEY_STOCK_PRICE, stockPrice);
  localStorage.setItem(KEY_SHARES, shares);

  localStorage.setItem(KEY_TREND_STATE, trendState);
  localStorage.setItem(KEY_TREND_UNTIL, trendUntilTs);

  localStorage.setItem(KEY_PRICE_SERIES, JSON.stringify(priceSeries));
}

function readInt(el) {
  const n = Number(el.value);
  if (!Number.isFinite(n) || n <= 0 || !Number.isInteger(n)) return null;
  return n;
}

/** =======================
 * é é‡‘åˆ©æ¯ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŠ ç®—ï¼‰
 * ======================= */
function applyBankInterestNow(nowTs = Date.now()) {
  const elapsedMs = nowTs - bankLastInterestTs;
  if (elapsedMs < INTEREST_INTERVAL_MS) return;

  const steps = Math.floor(elapsedMs / INTEREST_INTERVAL_MS);
  if (steps <= 0) return;

  if (bank > 0) {
    const factor = Math.pow(1 + INTEREST_RATE, steps) - 1;
    bankRemainder += bank * factor;

    const add = Math.floor(bankRemainder);
    if (add > 0) {
      bank += add;
      bankRemainder -= add;
    }
  }

  bankLastInterestTs += steps * INTEREST_INTERVAL_MS;
  saveAll();
}

/** =======================
 * è²¡å¸ƒ è‡ªå‹•å¢—åŠ ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆä¸­ã®ã¿ï¼‰
 * ======================= */
function tickWallet() {
  wallet += 1;
  saveAll();
  render();
}
function startWallet() {
  if (walletTimer) return;
  walletTimer = setInterval(tickWallet, intervalMs);
  setMsg(msgWallet, "è²¡å¸ƒã®è‡ªå‹•å¢—åŠ ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚");
  render();
}
function stopWallet() {
  if (!walletTimer) return;
  clearInterval(walletTimer);
  walletTimer = null;
  setMsg(msgWallet, "è²¡å¸ƒã®è‡ªå‹•å¢—åŠ ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚");
  render();
}

/** =======================
 * æ ªï¼šãƒˆãƒ¬ãƒ³ãƒ‰åˆ‡æ›¿
 * ======================= */
function refreshTrend(now = Date.now()) {
  if (now < trendUntilTs) return;
  trendState = (trendState === "BULL") ? "BEAR" : "BULL";
  const dur = Math.floor(randBetween(TREND_MIN_MS, TREND_MAX_MS));
  trendUntilTs = now + dur;
}

/** =======================
 * æ ªï¼šæ›´æ–°ï¼ˆå¸¸æ™‚ï¼‰
 * ======================= */
function tickStock() {
  const now = Date.now();
  refreshTrend(now);

  let eventLabel = "---";
  const r = Math.random();

  if (r < CRASH_PROB) {
    const m = randBetween(CRASH_MULT_MIN, CRASH_MULT_MAX);
    stockPrice = stockPrice * m;
    eventLabel = "æš´è½";
  } else if (r < CRASH_PROB + SUPER_BUBBLE_PROB) {
    stockPrice = stockPrice * SUPER_BUBBLE_MULT;
    eventLabel = "è¶…ãƒãƒ–ãƒ«";
  } else if (r < CRASH_PROB + SUPER_BUBBLE_PROB + BUBBLE_PROB) {
    stockPrice = stockPrice * BUBBLE_MULT_MIN;
    eventLabel = "ãƒãƒ–ãƒ«";
  } else {
    const drift = (trendState === "BULL") ? DRIFT_BULL : DRIFT_BEAR;
    const noise = (Math.random() - 0.5) * STOCK_VOLATILITY;
    const pull = (MEAN_PRICE - stockPrice) * MEAN_REVERT;
    stockPrice = stockPrice + drift + noise + pull;
  }

  if (stockPrice < STOCK_FLOOR) stockPrice = STOCK_FLOOR;

  priceSeries.push(Number(stockPrice.toFixed(1)));
  if (priceSeries.length > 60) priceSeries.shift();

  elEventState.textContent = eventLabel;

  saveAll();
  render();
  drawChart();
}

/** =======================
 * ãƒãƒ£ãƒ¼ãƒˆæç”»
 * ======================= */
function drawChart() {
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0, 0, w, h);

  ctx.beginPath();
  ctx.rect(0.5, 0.5, w - 1, h - 1);
  ctx.stroke();

  if (!priceSeries || priceSeries.length < 2) return;

  const minP = Math.min(...priceSeries);
  const maxP = Math.max(...priceSeries);
  const pad = (maxP - minP) === 0 ? 1 : (maxP - minP) * 0.1;
  const lo = minP - pad, hi = maxP + pad;

  ctx.font = "12px sans-serif";
  ctx.fillText(hi.toFixed(1), 6, 14);
  ctx.fillText(lo.toFixed(1), 6, h - 6);

  const n = priceSeries.length;
  ctx.beginPath();
  for (let i = 0; i < n; i++) {
    const x = (i / (n - 1)) * (w - 20) + 16;
    const v = priceSeries[i];
    const y = (1 - (v - lo) / (hi - lo)) * (h - 20) + 10;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.stroke();
}

/** =======================
 * æ ªï¼šå£²è²·
 * ======================= */
function buyShares() {
  const n = readInt(inpShareAmount);
  if (n === null) { setMsg(msgStock, "æ ªæ•°ã¯1ä»¥ä¸Šã®æ•´æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
  const total = n * stockPrice;
  if (wallet < total) { setMsg(msgStock, "è²¡å¸ƒãŒè¶³ã‚Šã¾ã›ã‚“ã€‚"); return; }
  wallet -= total;
  shares += n;
  saveAll();
  setMsg(msgStock, `é•·å°¾ãƒ†ãƒƒã‚¯ã‚’ ${n} æ ª è²·ã„ã¾ã—ãŸã€‚ï¼ˆ${Math.floor(total)}å††ï¼‰`);
  render();
}
function sellShares() {
  const n = readInt(inpShareAmount);
  if (n === null) { setMsg(msgStock, "æ ªæ•°ã¯1ä»¥ä¸Šã®æ•´æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
  if (shares < n) { setMsg(msgStock, "ä¿æœ‰æ ªãŒè¶³ã‚Šã¾ã›ã‚“ã€‚"); return; }
  const total = n * stockPrice;
  shares -= n;
  wallet += total;
  saveAll();
  setMsg(msgStock, `é•·å°¾ãƒ†ãƒƒã‚¯ã‚’ ${n} æ ª å£²ã‚Šã¾ã—ãŸã€‚ï¼ˆ${Math.floor(total)}å††ï¼‰`);
  render();
}

/** =======================
 * é é‡‘ï¼šå…¥å‡ºé‡‘
 * ======================= */
function deposit() {
  applyBankInterestNow();
  const amt = readInt(inpAmount);
  if (amt === null) { setMsg(msgBank, "é‡‘é¡ã¯1ä»¥ä¸Šã®æ•´æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
  if (wallet < amt) { setMsg(msgBank, "è²¡å¸ƒãŒè¶³ã‚Šã¾ã›ã‚“ã€‚"); return; }
  wallet -= amt; bank += amt;
  saveAll();
  setMsg(msgBank, `é é‡‘ã¸ ${amt} å†† å…¥ã‚Œã¾ã—ãŸã€‚`);
  render();
}
function withdraw() {
  applyBankInterestNow();
  const amt = readInt(inpAmount);
  if (amt === null) { setMsg(msgBank, "é‡‘é¡ã¯1ä»¥ä¸Šã®æ•´æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
  if (bank < amt) { setMsg(msgBank, "é é‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚"); return; }
  bank -= amt; wallet += amt;
  saveAll();
  setMsg(msgBank, `é é‡‘ã‹ã‚‰ ${amt} å†† å¼•ãå‡ºã—ã¾ã—ãŸã€‚`);
  render();
}

/** =======================
 * é€Ÿåº¦ã‚¢ãƒƒãƒ—ï¼ˆè²¡å¸ƒã®å¢—åŠ é€Ÿåº¦ã®ã¿ï¼‰
 * ======================= */
function buySpeedUp() {
  if (wallet < cost) { setMsg(msgWallet, "è²¡å¸ƒãŒè¶³ã‚Šã¾ã›ã‚“ã€‚"); return; }
  if (intervalMs <= MIN_INTERVAL) { setMsg(msgWallet, "ã“ã‚Œä»¥ä¸Šé€Ÿãã§ãã¾ã›ã‚“ã€‚"); return; }

  wallet -= cost;
  level += 1;
  intervalMs = Math.max(MIN_INTERVAL, intervalMs - 50);
  cost = Math.ceil(cost * 1.6);

  saveAll();

  if (walletTimer) {
    clearInterval(walletTimer);
    walletTimer = setInterval(tickWallet, intervalMs);
  }

  setMsg(msgWallet, "é«˜é€ŸåŒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è³¼å…¥ã—ã¾ã—ãŸã€‚");
  render();
}

/** =======================
 * ã‚¹ãƒ­ãƒƒãƒˆï¼šæŠ½é¸
 * ======================= */
function buildCdf(symbols) {
  const total = symbols.reduce((a, x) => a + x.w, 0);
  let acc = 0;
  return symbols.map(x => {
    acc += x.w / total;
    return { s: x.s, p: acc };
  });
}
const CDF = buildCdf(SYMBOLS);

function drawSymbol() {
  const r = Math.random();
  for (const x of CDF) if (r <= x.p) return x.s;
  return CDF[CDF.length - 1].s;
}

function prob(sym) {
  const total = SYMBOLS.reduce((a,x)=>a+x.w,0);
  const obj = SYMBOLS.find(x=>x.s===sym);
  return (obj ? obj.w : 0) / total;
}

function baseWinMultiplier(a,b,c) {
  if (a===b && b===c) return BASE_PAYOUT_3[a] || 0;
  if (a===b || a===c) return BASE_PAYOUT_2[a] || 0;
  if (b===c) return BASE_PAYOUT_2[b] || 0;
  return 0;
}

function computeBaseRtp() {
  const syms = SYMBOLS.map(x=>x.s);
  let ev = 0;
  for (const a of syms) for (const b of syms) for (const c of syms) {
    const p = prob(a)*prob(b)*prob(c);
    ev += p * baseWinMultiplier(a,b,c);
  }
  return ev;
}

const BASE_RTP = computeBaseRtp();
let PAYOUT_SCALE = (BASE_RTP > 0) ? (TARGET_RTP / BASE_RTP) : 1;

function scaledWinMultiplier(a,b,c) {
  return baseWinMultiplier(a,b,c) * PAYOUT_SCALE;
}

function setReelSpinning(on) {
  const cls = on ? "reel spin" : "reel";
  reel1.className = cls;
  reel2.className = cls;
  reel3.className = cls;
}

let spinning = false;

function spinOnce() {
  if (spinning) return;

  const bet = readInt(inpBet);
  if (bet === null) { setMsg(msgSlot, "ãƒ™ãƒƒãƒˆé¡ã¯1ä»¥ä¸Šã®æ•´æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
  if (wallet < bet) { setMsg(msgSlot, "è²¡å¸ƒãŒè¶³ã‚Šã¾ã›ã‚“ã€‚"); stopAuto(); return; }

  spinning = true;
  setReelSpinning(true);

  wallet -= bet;

  let ticks = 0;
  const tempTimer = setInterval(() => {
    reel1.textContent = drawSymbol();
    reel2.textContent = drawSymbol();
    reel3.textContent = drawSymbol();
    ticks++;
    if (ticks >= 8) {
      clearInterval(tempTimer);

      const a = drawSymbol();
      const b = drawSymbol();
      const c = drawSymbol();

      reel1.textContent = a;
      reel2.textContent = b;
      reel3.textContent = c;

      const mult = scaledWinMultiplier(a,b,c);
      const win = Math.floor(bet * mult);

      if (win > 0) wallet += win;

      saveAll();
      render();

      if (win > 0) {
        setMsg(msgSlot, `å½“ãŸã‚Šï¼š${a}${b}${c}\nå€ç‡ï¼š${mult.toFixed(2)}x\næ‰•ã„æˆ»ã—ï¼š${win} å††`);
      } else {
        setMsg(msgSlot, `ã¯ãšã‚Œï¼š${a}${b}${c}\næ‰•ã„æˆ»ã—ï¼š0 å††`);
      }

      setReelSpinning(false);
      spinning = false;
    }
  }, 60);
}

function startAuto() {
  if (autoTimer) return;
  setMsg(msgSlot, "ã‚ªãƒ¼ãƒˆé–‹å§‹ã€‚");
  autoTimer = setInterval(() => {
    if (!spinning) spinOnce();
  }, AUTO_SPIN_MS);
}

function stopAuto() {
  if (!autoTimer) return;
  clearInterval(autoTimer);
  autoTimer = null;
  setMsg(msgSlot, "ã‚ªãƒ¼ãƒˆåœæ­¢ã€‚");
}

/** =======================
 * è¡¨ç¤ºæ›´æ–°
 * ======================= */
function render() {
  applyBankInterestNow();

  elWallet.textContent = Math.floor(wallet);
  elBank.textContent   = Math.floor(bank);

  elInterval.textContent = intervalMs;
  elCost.textContent = cost;
  elLevel.textContent = level;

  elRateText.textContent = `${(INTEREST_RATE * 100).toFixed(4)}%`;
  elInterestIntervalText.textContent = `${(INTEREST_INTERVAL_MS / 1000).toFixed(0)}ç§’ã”ã¨`;

  elStockPrice.textContent = stockPrice.toFixed(1);
  elShares.textContent = shares;
  elPositionValue.textContent = Math.floor(shares * stockPrice);
  elTrendState.textContent = (trendState === "BULL") ? "ä¸Šæ˜‡æœŸ" : "ä¸‹è½æœŸ";

  elStockTickText.textContent = `${(STOCK_TICK_MS / 1000).toFixed(0)}ç§’ã”ã¨`;
  elStockVolText.textContent = `${STOCK_VOLATILITY.toFixed(1)}`;
  elCrashProbText.textContent = `${(CRASH_PROB*100).toFixed(2)}%/ç§’`;
  elBubbleProbText.textContent = `${(BUBBLE_PROB*100).toFixed(2)}%/ç§’`;
  elSuperBubbleProbText.textContent = `${(SUPER_BUBBLE_PROB*100).toFixed(2)}%/ç§’`;

  elCrashMultText.textContent = `Ã—${CRASH_MULT_MIN.toFixed(2)}ã€œÃ—${CRASH_MULT_MAX.toFixed(2)}`;
  elBubbleMultText.textContent = `Ã—${BUBBLE_MULT_MIN.toFixed(2)}ï¼ˆå›ºå®šï¼‰`;
  elSuperBubbleMultText.textContent = `Ã—${SUPER_BUBBLE_MULT.toFixed(2)}ï¼ˆå›ºå®šï¼‰`;

  elMeanPriceText.textContent = `${MEAN_PRICE}`;
  elMeanRevertText.textContent = `${MEAN_REVERT}`;

  elRtpText.textContent = (TARGET_RTP * 100).toFixed(2) + "%";
  elScaleText.textContent = PAYOUT_SCALE.toFixed(4);

  btnStart.disabled = !!walletTimer;
  btnBuy.disabled = (wallet < cost) || (intervalMs <= MIN_INTERVAL);
  btnSellShares.disabled = (shares <= 0);

  btnAutoStop.disabled = !autoTimer;
  btnAutoStart.disabled = !!autoTimer;
}

/** =======================
 * ã‚¤ãƒ™ãƒ³ãƒˆ
 * ======================= */
btnStart.onclick = startWallet;
btnStop.onclick  = stopWallet;
btnBuy.onclick   = buySpeedUp;

btnDeposit.onclick = deposit;
btnWithdraw.onclick = withdraw;

btnBuyShares.onclick = buyShares;
btnSellShares.onclick = sellShares;

btnSpin.onclick = spinOnce;
btnAutoStart.onclick = startAuto;
btnAutoStop.onclick = stopAuto;

// ã‚¿ãƒ–éè¡¨ç¤ºï¼šè²¡å¸ƒå¢—åŠ ã¯åœæ­¢ï¼ˆæ ªã¯ç¶™ç¶šï¼‰ã€‚ã‚ªãƒ¼ãƒˆã¯äº‹æ•…é˜²æ­¢ã§åœæ­¢ï¼ˆä¸è¦ãªã‚‰ stopAuto() è¡Œã‚’æ¶ˆã—ã¦ãã ã•ã„ï¼‰
document.addEventListener("visibilitychange", () => {
  if (document.hidden) {
    stopWallet();
    stopAuto();
  } else {
    applyBankInterestNow();
    render();
    drawChart();
  }
});

window.addEventListener("beforeunload", () => {
  applyBankInterestNow();
  saveAll();
});
window.addEventListener("pagehide", () => {
  applyBankInterestNow();
  saveAll();
});

/** =======================
 * èµ·å‹•
 * ======================= */
function boot() {
  applyBankInterestNow();

  if (!stockTimer) stockTimer = setInterval(tickStock, STOCK_TICK_MS);
  if (!chartTimer) chartTimer = setInterval(drawChart, 1000);

  render();
  drawChart();
}
boot();
</script>

<!-- Service Worker ç™»éŒ²ï¼ˆPWAï¼‰ -->
<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js");
  });
}
</script>

</body>
</html>

